<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CS Match History</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center">
    <div class="container mx-auto p-6 text-center">
        <h1 class="text-4xl font-bold mb-4">CS Match History</h1>
        <p class="text-lg mb-4">
            Enter a Steam64 ID to fetch and display matches uploaded to Leetify.
        </p>

        <div class="mb-6">
            <input
                id="steamIdInput"
                type="text"
                placeholder="Enter Steam64 ID"
                class="bg-gray-800 text-white p-2 rounded-lg w-64 mx-auto"
            >
            <button
                id="fetchMatches"
                class="bg-pink-500 hover:bg-pink-600 text-white font-semibold py-2 px-4 rounded-lg ml-2"
            >
                Fetch Matches
            </button>
        </div>

        <div id="errorMessage" class="text-red-500 hidden mb-4"></div>

        <div id="filters" class="mb-4 hidden flex justify-center space-x-4">
            <select id="filterSource" class="bg-gray-800 text-white p-2 rounded-lg">
                <option value="">All Sources</option>
            </select>
            <select id="filterMap" class="bg-gray-800 text-white p-2 rounded-lg">
                <option value="">All Maps</option>
            </select>
        </div>

        <div id="matchData" class="bg-gray-800 p-6 rounded-lg shadow-lg mb-6 hidden">
            <h2 class="text-2xl font-semibold mb-2">Match Data</h2>
            <table class="w-full text-left mx-auto">
                <thead>
                    <tr class="border-b border-gray-600">
                        <th class="py-2">Map</th>
                        <th class="py-2">Date</th>
                        <th class="py-2">Score</th>
                        <th class="py-2 cursor-pointer" onclick="sortTable('rating')">Rating</th>
                        <th class="py-2 cursor-pointer" onclick="sortTable('ctRating')">CT Rating</th>
                        <th class="py-2 cursor-pointer" onclick="sortTable('tRating')">T Rating</th>
                        <th class="py-2">Kills</th>
                        <th class="py-2">Deaths</th>
                        <th class="py-2">K/D</th>
                        <th class="py-2">Source</th>
                    </tr>
                </thead>
                <tbody id="matchList"></tbody>
            </table>
            <p class="mt-2">
                <a href="https://leetify.com/" class="text-pink-500 underline" target="_blank">View on Leetify</a>
            </p>
        </div>

        <footer class="mt-6 flex items-center justify-center">
            <a href="https://leetify.com/" target="_blank">
                <img src="leetify-logo.png" alt="Data Provided by Leetify" class="h-12" onerror="this.src='https://via.placeholder.com/48?text=Leetify+Logo'; console.log('Logo failed, using fallback');">
            </a>
            <p class="ml-4 text-sm text-gray-400">Data Provided by Leetify</p>
        </footer>
    </div>

    <script>
        function formatMapName(mapName) {
            if (!mapName) return 'N/A';
            return mapName
                .replace('de_', '')
                .replace(/([A-Z])/g, ' $1')
                .replace(/^./, str => str.toUpperCase())
                .trim();
        }

        function formatSource(source) {
            if (!source) return 'N/A';
            return source
                .replace('hltv', 'HLTV')
                .replace('faceit', 'Faceit')
                .replace('matchmaking', 'Matchmaking');
        }

        function formatRating(rating) {
            if (rating === null || rating === undefined || isNaN(rating)) return 'N/A';
            const scaledRating = rating * 100;
            return scaledRating >= 0 ? `+${scaledRating.toFixed(2)}` : `${scaledRating.toFixed(2)}`;
        }

        function getRatingColor(rating) {
            if (rating === 'N/A') return '';
            const scaledRating = rating * 100;
            if (scaledRating > 5.12) return 'text-green-500';
            if (scaledRating >= 2.09) return 'text-green-300';
            if (scaledRating >= -2.09) return 'text-white';
            if (scaledRating >= -5.12) return 'text-yellow-500';
            return 'text-red-500';
        }

        let allMatches = [];
        let sortState = { rating: 0, ctRating: 0, tRating: 0 }; // 0: default (date), 1: descending, 2: back to default

        document.getElementById('fetchMatches').addEventListener('click', async () => {
            const steamId = document.getElementById('steamIdInput').value.trim();
            const errorMessage = document.getElementById('errorMessage');
            const matchDataDiv = document.getElementById('matchData');
            const matchList = document.getElementById('matchList');
            const filtersDiv = document.getElementById('filters');
            const filterSource = document.getElementById('filterSource');
            const filterMap = document.getElementById('filterMap');

            errorMessage.classList.add('hidden');
            matchDataDiv.classList.add('hidden');
            matchList.innerHTML = '';
            filtersDiv.classList.add('hidden'); // Hide filters initially
            filterSource.innerHTML = '<option value="">All Sources</option>';
            filterMap.innerHTML = '<option value="">All Maps</option>';
            sortState = { rating: 0, ctRating: 0, tRating: 0 }; // Reset sort state

            if (!steamId) {
                errorMessage.textContent = 'Please enter a valid Steam64 ID.';
                errorMessage.classList.remove('hidden');
                return;
            }

            try {
                const response = await fetch(`https://api-public.cs-prod.leetify.com/v3/profile/matches?steam64_id=${steamId}`);
                const data = await response.json();

                if (data.error) {
                    errorMessage.textContent = data.error;
                    errorMessage.classList.remove('hidden');
                    return;
                }

                if (!Array.isArray(data) || data.length === 0) {
                    errorMessage.textContent = 'No matches found for this Steam64 ID.';
                    errorMessage.classList.remove('hidden');
                    return;
                }

                allMatches = data.map(match => {
                    const playerStats = Array.isArray(match.stats) ? match.stats.find(stat => stat.steam64_id === steamId) || {} : {};
                    return {
                        id: match.id,
                        mapName: formatMapName(match.map_name),
                        date: match.finished_at && !isNaN(new Date(match.finished_at).getTime()) ? new Date(match.finished_at).toISOString().split('T')[0] : 'Date not available',
                        score: `${playerStats.rounds_won || 0}:${playerStats.rounds_lost || 0}`,
                        rating: playerStats.leetify_rating,
                        ctRating: playerStats.ct_leetify_rating,
                        tRating: playerStats.t_leetify_rating,
                        kills: playerStats.total_kills || 'N/A',
                        deaths: playerStats.total_deaths || 'N/A',
                        kd: playerStats.kd_ratio || 'N/A',
                        source: formatSource(match.data_source)
                    };
                }).sort((a, b) => new Date(b.date) - new Date(a.date)); // Default sort by newest date

                // Populate filters
                const uniqueSources = [...new Set(allMatches.map(match => match.source))].sort();
                const uniqueMaps = [...new Set(allMatches.map(match => match.mapName))].sort();
                uniqueSources.forEach(source => {
                    const option = document.createElement('option');
                    option.value = source;
                    option.textContent = source;
                    filterSource.appendChild(option);
                });
                // Ensure "Inferno" is included if not already present
                if (!uniqueMaps.includes('Inferno') && allMatches.some(match => match.mapName.toLowerCase() === 'inferno')) {
                    uniqueMaps.push('Inferno');
                }
                uniqueMaps.forEach(map => {
                    const option = document.createElement('option');
                    option.value = map;
                    option.textContent = map;
                    filterMap.appendChild(option);
                });

                filtersDiv.classList.remove('hidden'); // Show filters after successful fetch
                applyFilters();

                matchDataDiv.classList.remove('hidden');
            } catch (error) {
                errorMessage.textContent = 'Failed to fetch match data. Please try again later.';
                errorMessage.classList.remove('hidden');
                console.error('Fetch error:', error);
            }
        });

        function applyFilters() {
            const filterSource = document.getElementById('filterSource').value;
            const filterMap = document.getElementById('filterMap').value;
            const matchList = document.getElementById('matchList');
            matchList.innerHTML = '';

            const filteredMatches = allMatches.filter(match => {
                const sourceMatch = !filterSource || match.source === filterSource;
                const mapMatch = !filterMap || match.mapName === filterMap;
                return sourceMatch && mapMatch;
            });

            sortTable(); // Apply current sort state
            filteredMatches.forEach(match => {
                const matchLink = match.id ? `https://leetify.com/app/match-details/${match.id}/overview` : '#';
                console.log('Generated matchLink:', matchLink);
                const scoreColor = match.score.split(':')[0] > match.score.split(':')[1] ? 'text-green-500' : match.score.split(':')[1] > match.score.split(':')[0] ? 'text-red-500' : '';
                const ratingText = formatRating(match.rating);
                const ratingColor = getRatingColor(match.rating);
                const ctRatingText = formatRating(match.ctRating);
                const ctRatingColor = getRatingColor(match.ctRating);
                const tRatingText = formatRating(match.tRating);
                const tRatingColor = getRatingColor(match.tRating);
                const source = match.source;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="py-2">
                        <a href="${matchLink}" target="_blank" class="text-pink-500 underline">
                            ${match.mapName}
                        </a>
                    </td>
                    <td class="py-2">${match.date}</td>
                    <td class="py-2 ${scoreColor}">${match.score}</td>
                    <td class="py-2 ${ratingColor}">${ratingText}</td>
                    <td class="py-2 ${ctRatingColor}">${ctRatingText}</td>
                    <td class="py-2 ${tRatingColor}">${tRatingText}</td>
                    <td class="py-2">${match.kills}</td>
                    <td class="py-2">${match.deaths}</td>
                    <td class="py-2">${match.kd}</td>
                    <td class="py-2">${source}</td>
                `;
                matchList.appendChild(row);
            });
        }

        function sortTable(column) {
            const filterSource = document.getElementById('filterSource').value;
            const filterMap = document.getElementById('filterMap').value;
            const matchList = document.getElementById('matchList');

            if (!column) {
                column = Object.keys(sortState).find(key => sortState[key] === 1) || 'date';
            }

            if (sortState[column] === 0 || sortState[column] === 2) {
                sortState[column] = 1; // Sort descending
            } else {
                sortState[column] = 2; // Reset to default (date)
                column = 'date';
            }

            Object.keys(sortState).forEach(key => {
                if (key !== column) sortState[key] = 0;
            });

            let sortedMatches = [...allMatches];
            if (column === 'date') {
                sortedMatches.sort((a, b) => new Date(b.date) - new Date(a.date));
            } else {
                sortedMatches.sort((a, b) => {
                    const aValue = a[column] === 'N/A' ? -Infinity : a[column];
                    const bValue = b[column] === 'N/A' ? -Infinity : b[column];
                    return sortState[column] === 1 ? bValue - aValue : aValue - bValue;
                });
            }

            const filteredMatches = sortedMatches.filter(match => {
                const sourceMatch = !filterSource || match.source === filterSource;
                const mapMatch = !filterMap || match.mapName === filterMap;
                return sourceMatch && mapMatch;
            });

            matchList.innerHTML = '';
            filteredMatches.forEach(match => {
                const matchLink = match.id ? `https://leetify.com/app/match-details/${match.id}/overview` : '#';
                console.log('Generated matchLink:', matchLink);
                const scoreColor = match.score.split(':')[0] > match.score.split(':')[1] ? 'text-green-500' : match.score.split(':')[1] > match.score.split(':')[0] ? 'text-red-500' : '';
                const ratingText = formatRating(match.rating);
                const ratingColor = getRatingColor(match.rating);
                const ctRatingText = formatRating(match.ctRating);
                const ctRatingColor = getRatingColor(match.ctRating);
                const tRatingText = formatRating(match.tRating);
                const tRatingColor = getRatingColor(match.tRating);
                const source = match.source;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="py-2">
                        <a href="${matchLink}" target="_blank" class="text-pink-500 underline">
                            ${match.mapName}
                        </a>
                    </td>
                    <td class="py-2">${match.date}</td>
                    <td class="py-2 ${scoreColor}">${match.score}</td>
                    <td class="py-2 ${ratingColor}">${ratingText}</td>
                    <td class="py-2 ${ctRatingColor}">${ctRatingText}</td>
                    <td class="py-2 ${tRatingColor}">${tRatingText}</td>
                    <td class="py-2">${match.kills}</td>
                    <td class="py-2">${match.deaths}</td>
                    <td class="py-2">${match.kd}</td>
                    <td class="py-2">${source}</td>
                `;
                matchList.appendChild(row);
            });
        }

        document.getElementById('filterSource').addEventListener('change', applyFilters);
        document.getElementById('filterMap').addEventListener('change', applyFilters);
    </script>
</body>
</html>
